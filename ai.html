<!DOCTYPE html>
<html>
<head>
    <title>AI Control Panel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; display: flex; height: 100vh; margin: 0; }
        #sidebar { width: 250px; background: #252525; border-right: 1px solid #444; padding: 20px; }
        #main-chat { flex: 1; display: flex; flex-direction: column; display: none; }
        .user-item { padding: 10px; background: #333; margin-bottom: 5px; cursor: pointer; border-radius: 5px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; background: #111; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; }
        .guest { background: #444; align-self: flex-start; }
        .ai { background: #007bff; align-self: flex-end; margin-left: auto; }
        .controls { padding: 20px; background: #252525; display: flex; gap: 10px; }
        input { padding: 10px; border-radius: 5px; border: none; }
        button { padding: 10px; cursor: pointer; border-radius: 5px; border: none; background: #28a745; color: white; }
        .btn-danger { background: #dc3545; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Khách đang đợi</h3>
        <div id="waiting-list"></div>
    </div>

    <div id="main-chat">
        <div style="padding: 10px; background: #333; display: flex; gap: 10px;">
            <input type="text" id="ai-name" placeholder="Đặt tên AI (ví dụ: GPT-5)">
            <button onclick="updateAiName()">Đổi tên</button>
            <button class="btn-danger" onclick="clearChat()">Xóa Chat bên khách</button>
            <button class="btn-danger" onclick="terminate()">Ngắt kết nối</button>
        </div>
        <div id="messages"></div>
        <div class="controls">
            <input type="text" id="msg-input" style="flex:1" placeholder="Nhập nội dung phản hồi...">
            <button onclick="sendMsg()">Gửi (AI)</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentGuestId = null;

        socket.on('update_waiting_list', (users) => {
            const list = document.getElementById('waiting-list');
            list.innerHTML = users.map(u => `<div class="user-item" onclick="connectUser('${u.id}')">${u.name} (Kết nối)</div>`).join('');
        });

        function connectUser(id) {
            currentGuestId = id;
            socket.emit('ai_connect_user', id);
            document.getElementById('main-chat').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
        }

        function sendMsg() {
            const val = document.getElementById('msg-input').value;
            if(!val) return;
            socket.emit('send_message', { text: val, sender: 'ai' });
            addMsg(val, 'ai');
            document.getElementById('msg-input').value = '';
        }

        function updateAiName() {
            const name = document.getElementById('ai-name').value;
            socket.emit('change_ai_name', name);
            alert("Đã đổi tên hiển thị bên khách!");
        }

        function clearChat() { socket.emit('clear_chat_request'); document.getElementById('messages').innerHTML = ''; }
        
        function terminate() {
            socket.emit('disconnect_request');
            location.reload();
        }

        socket.on('receive_message', (data) => addMsg(data.text, 'guest'));

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 9999;
        }
    </script>
</body>
</html>
