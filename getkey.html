<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANSRIPT | GET KEY SYSTEM</title>
    <style>
        :root { --p: #bdacff; --g: #00ffcc; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }

        /* Hiệu ứng hạt lơ lửng */
        .bg-animate { position: absolute; width: 100%; height: 100%; z-index: -1; }
        .circle { position: absolute; background: rgba(189, 172, 255, 0.07); border-radius: 50%; filter: blur(60px); animation: float 10s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-40px) scale(1.1); } }

        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(189, 172, 255, 0.15); border-radius: 20px; padding: 40px; width: 360px; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        
        h1 { color: var(--p); margin: 0; font-size: 28px; letter-spacing: 2px; text-shadow: 0 0 10px var(--p); }
        .status-txt { margin: 15px 0; font-size: 14px; opacity: 0.7; }
        
        .btn { background: var(--p); color: black; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 15px; }
        .btn:hover { transform: scale(1.03); box-shadow: 0 0 20px var(--p); }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; }

        .key-display { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.4); border: 1px dashed var(--g); border-radius: 10px; display: none; }
        .key-display b { font-family: monospace; font-size: 20px; color: var(--g); display: block; margin: 10px 0; }
        
        .copy-info { font-size: 11px; color: var(--g); margin-top: 5px; display: none; }
    </style>
</head>
<body>
    <div class="bg-animate">
        <div class="circle" style="width:300px; height:300px; top:10%; left:5%;"></div>
        <div class="circle" style="width:200px; height:200px; bottom:15%; right:10%; animation-delay: 2s;"></div>
    </div>

    <div class="glass">
        <h1>ANSRIPT HUB</h1>
        <div id="status" class="status-txt">Vui lòng hoàn thành checkpoint để lấy key</div>
        
        <div id="step-ui">
            <button id="main-btn" class="btn" onclick="handleStep()">BẮT ĐẦU GET KEY (STEP 1/2)</button>
        </div>

        <div id="key-display" class="key-display">
            <span style="font-size: 12px; opacity: 0.8;">KEY CỦA BẠN (HẠN 24H):</span>
            <b id="key-text">ans-xxxxxxxx</b>
            <button class="btn" style="padding: 8px; font-size: 12px;" onclick="copyKey()">SAO CHÉP KEY</button>
            <div id="copy-msg" class="copy-info">Đã sao chép vào bộ nhớ tạm!</div>
        </div>
    </div>

    <script>
        // Lấy thông tin từ URL
        const urlParams = new URLSearchParams(window.location.search);
        let currentStep = urlParams.get('step') || "1";
        const mainBtn = document.getElementById('main-btn');
        const statusTxt = document.getElementById('status');

        // 1. Kiểm tra nếu đã có Key trong máy (Fix lỗi load lại trang đổi key)
        const savedKey = localStorage.getItem('ans_current_key');
        if (savedKey) {
            showFinalKey(savedKey);
        } else if (currentStep === "done") {
            generateNewKey();
        } else if (currentStep === "2") {
            statusTxt.innerText = "Checkpoint 1 hoàn tất! Tiếp tục bước cuối.";
            mainBtn.innerText = "TIẾP TỤC (STEP 2/2)";
        }

        // 2. Hàm điều hướng Linkvertise (An hãy đổi ID 2650959 thành ID của An nếu cần)
        async function handleStep() {
            mainBtn.disabled = true;
            mainBtn.innerText = "ĐANG TẠO LINK...";
            
            try {
                // Gọi API từ server.js để lấy link Linkvertise tránh bị lộ ID/Target
                const response = await fetch(`/api/get-link?step=${currentStep}`);
                const data = await response.json();
                
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert("Lỗi server: Không thể tạo link!");
                    mainBtn.disabled = false;
                }
            } catch (e) {
                alert("Lỗi kết nối Server Railway!");
                mainBtn.disabled = false;
            }
        }

        // 3. Hàm tạo Key mới sau khi xong Step 2
        async function generateNewKey() {
            statusTxt.innerText = "Đang tạo key cho bạn...";
            mainBtn.style.display = "none";

            try {
                const response = await fetch('/api/generate-key');
                const data = await response.json();
                
                if (data.key) {
                    localStorage.setItem('ans_current_key', data.key);
                    showFinalKey(data.key);
                }
            } catch (e) {
                statusTxt.innerText = "Lỗi khi tạo key. Hãy thử lại!";
            }
        }

        // 4. Hàm hiển thị Key lên màn hình
        function showFinalKey(key) {
            statusTxt.innerHTML = "✅ XÁC MINH THÀNH CÔNG!";
            document.getElementById('step-ui').style.display = "none";
            document.getElementById('key-display').style.display = "block";
            document.getElementById('key-text').innerText = key;
        }

        // 5. Hàm sao chép
        function copyKey() {
            const keyText = document.getElementById('key-text').innerText;
            navigator.clipboard.writeText(keyText);
            document.getElementById('copy-msg').style.display = "block";
            setTimeout(() => { document.getElementById('copy-msg').style.display = "none"; }, 2000);
        }
    </script>
</body>
</html>
