<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Master Admin</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Reset & Fix chiều cao toàn màn hình */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: sans-serif; display: flex; background: #0f0f0f; color: #e0e0e0; }

        #sidebar { width: 200px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #333; font-size: 14px; background: #222; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-card { background: #333; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border-left: 4px solid #0084ff; font-size: 13px; }

        #main-chat { flex: 1; display: none; flex-direction: column; background: #000; height: 100%; }
        
        /* Thanh công cụ trên cùng */
        .tools { background: #222; padding: 10px; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid #333; flex-wrap: wrap; }
        .tools input[type="text"] { background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; flex: 1; min-width: 100px; }
        
        /* Khu vực tin nhắn */
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 10px; max-width: 75%; line-height: 1.4; font-size: 14px; }
        .guest { background: #333; align-self: flex-start; border: 1px solid #444; }
        .ai { background: #0084ff; align-self: flex-end; color: white; }

        /* BẢNG THEO DÕI GÕ PHÍM - LUÔN NỔI BẬT */
        .typing-monitor { background: #ff9800; color: #000; padding: 8px 15px; font-weight: bold; font-family: monospace; font-size: 13px; border-top: 1px solid #e68a00; }

        /* KHU VỰC NHẬP LIỆU - ĐƯỢC ĐẨY LÊN TRÊN */
        .input-area { background: #222; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #333; padding-bottom: 25px; /* Thêm padding dưới để tránh dính cạnh */ }
        .input-area input { flex: 1; background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 5px; outline: none; }
        
        button { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-blue { background: #0084ff; color: white; }
        .btn-red { background: #cc0000; color: white; }
        .btn-send { padding: 0 20px; }
        .btn-send:disabled { background: #444; color: #888; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">Khách đang đợi</div>
        <div id="user-list"></div>
    </div>

    <div id="main-chat">
        <div class="tools">
            <input type="text" id="set-ai-name" placeholder="Tên AI...">
            <button class="btn-blue" onclick="updateName()">Đổi Tên</button>
            <input type="color" id="set-color" onchange="updateColor()" style="width:30px; height:30px; padding:0; border:none;">
            <button class="btn-red" onclick="socket.emit('clear_chat_request')">Xóa</button>
            <button class="btn-red" style="background:#555" onclick="location.reload()">Ngắt</button>
        </div>
        
        <div id="messages"></div>

        <div class="typing-monitor" id="typing-box">KHÁCH ĐANG GÕ: ...</div>

        <div class="input-area">
            <input type="text" id="ai-msg" placeholder="Đang xem khách gõ gì..." disabled oninput="aiTyping()">
            <button id="send-btn" class="btn-blue btn-send" onclick="send()" disabled>GỬI</button>
        </div>
    </div>

    <script>
        const socket = io();
        let turn = false;

        socket.on('update_waiting_list', (users) => {
            document.getElementById('user-list').innerHTML = users.map(u => 
                `<div class="user-card" onclick="connect('${u.id}')"><b>${u.name}</b></div>`
            ).join('');
        });

        function connect(id) {
            socket.emit('ai_connect_user', id);
            document.getElementById('main-chat').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
        }

        function setTurn(isT) {
            turn = isT;
            const inp = document.getElementById('ai-msg');
            inp.disabled = !isT;
            document.getElementById('send-btn').disabled = !isT;
            inp.placeholder = isT ? "Trả lời khách..." : "Chờ khách nhắn xong...";
            if(isT) inp.focus();
        }

        function aiTyping() { 
            socket.emit('ai_typing_status', document.getElementById('ai-msg').value.length > 0); 
        }

        function send() {
            const val = document.getElementById('ai-msg').value;
            if(val && turn) {
                addMsg(val, 'ai');
                socket.emit('send_message', { text: val });
                socket.emit('ai_typing_status', false);
                setTurn(false);
                document.getElementById('ai-msg').value = '';
            }
        }

        socket.on('receive_message', (data) => { 
            addMsg(data.text, 'guest'); 
            setTurn(true); 
            document.getElementById('typing-box').innerText = "KHÁCH ĐÃ GỬI XONG.";
        });
        
        socket.on('guest_typing_preview', (text) => {
            document.getElementById('typing-box').innerText = text ? "KHÁCH ĐANG GÕ: " + text : "KHÁCH ĐANG ĐỢI...";
        });

        function updateName() { socket.emit('change_ai_name', document.getElementById('set-ai-name').value); }
        function updateColor() { socket.emit('change_color', document.getElementById('set-color').value); }

        function addMsg(t, type) {
            const d = document.createElement('div');
            d.className = 'msg ' + type;
            d.innerText = t;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
    </script>
</body>
</html>
