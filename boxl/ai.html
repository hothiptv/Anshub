<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Master Admin</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #0f0f0f; color: #e0e0e0; overflow: hidden; }
        #sidebar { width: 300px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #333; background: #222; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-card { background: #333; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; border-left: 4px solid #0084ff; }
        .user-card:hover { background: #444; }
        
        #main-chat { flex: 1; display: none; flex-direction: column; position: relative; }
        .tools { background: #222; padding: 15px; display: flex; gap: 10px; flex-wrap: wrap; border-bottom: 1px solid #333; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #000; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 70%; line-height: 1.4; }
        .guest { background: #333; align-self: flex-start; border: 1px solid #444; }
        .ai { background: #0084ff; align-self: flex-end; }
        
        /* BẢNG THEO DÕI GÕ PHÍM */
        .typing-monitor { background: #ff9800; color: #000; padding: 10px 20px; font-weight: bold; border-top: 2px solid #e68a00; font-family: monospace; }
        
        .input-area { background: #222; padding: 20px; display: flex; gap: 10px; }
        input { background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 5px; outline: none; }
        button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-blue { background: #0084ff; color: white; }
        .btn-red { background: #cc0000; color: white; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header"><h3>Khách Đang Chờ</h3></div>
        <div id="user-list"></div>
    </div>

    <div id="main-chat">
        <div class="tools">
            <input type="text" id="set-ai-name" placeholder="Tên AI...">
            <button class="btn-blue" onclick="updateName()">Đổi Tên</button>
            <input type="color" id="set-color" onchange="updateColor()" title="Đổi màu giao diện">
            <button class="btn-red" onclick="socket.emit('clear_chat_request')">Xóa Chat</button>
            <button class="btn-red" style="background:#666" onclick="location.reload()">Ngắt kết nối</button>
        </div>
        
        <div id="messages"></div>

        <div class="typing-monitor" id="typing-box">KHÁCH ĐANG GÕ: ...</div>

        <div class="input-area">
            <input type="text" id="ai-msg" style="flex:1" placeholder="Chờ khách nhắn xong mới được trả lời..." disabled oninput="aiTyping()">
            <button id="send-btn" class="btn-blue" onclick="send()" disabled>GỬI TIN NHẮN</button>
        </div>
    </div>

    <script>
        const socket = io();
        let turn = false;

        socket.on('update_waiting_list', (users) => {
            document.getElementById('user-list').innerHTML = users.map(u => 
                `<div class="user-card" onclick="connect('${u.id}')"><b>${u.name}</b><br><small>Đang đợi kết nối...</small></div>`
            ).join('');
        });

        function connect(id) {
            socket.emit('ai_connect_user', id);
            document.getElementById('main-chat').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
        }

        function setTurn(isT) {
            turn = isT;
            const inp = document.getElementById('ai-msg');
            inp.disabled = !isT;
            document.getElementById('send-btn').disabled = !isT;
            inp.placeholder = isT ? "Nhập câu trả lời AI..." : "Đang xem khách gõ gì...";
        }

        function aiTyping() { socket.emit('ai_typing_status', document.getElementById('ai-msg').value.length > 0); }

        function send() {
            const val = document.getElementById('ai-msg').value;
            if(val && turn) {
                addMsg(val, 'ai');
                socket.emit('send_message', { text: val });
                socket.emit('ai_typing_status', false);
                setTurn(false);
                document.getElementById('ai-msg').value = '';
            }
        }

        socket.on('receive_message', (data) => { addMsg(data.text, 'guest'); setTurn(true); });
        
        socket.on('guest_typing_preview', (text) => {
            document.getElementById('typing-box').innerText = text ? "KHÁCH ĐANG GÕ: " + text : "KHÁCH ĐANG ĐỢI...";
        });

        function updateName() { socket.emit('change_ai_name', document.getElementById('set-ai-name').value); }
        function updateColor() { socket.emit('change_color', document.getElementById('set-color').value); }

        function addMsg(t, type) {
            const d = document.createElement('div');
            d.className = 'msg ' + type;
            d.innerText = t;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = 99999;
        }
    </script>
</body>
</html>
